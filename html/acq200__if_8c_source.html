<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>ACQ200 HOSTDRV: acq200_if.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">ACQ200 HOSTDRV</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">acq200_if.c</div>  </div>
</div>
<div class="contents">
<a href="acq200__if_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00002"></a>00002 <span class="comment">/* acq200if.c interface layer for acq200 peripheral                          */</span>
<a name="l00003"></a>00003 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00004"></a>00004 <span class="comment">/*   Copyright (C) 2006 Peter Milne, D-TACQ Solutions Ltd</span>
<a name="l00005"></a>00005 <span class="comment"> *                      &lt;Peter dot Milne at D hyphen TACQ dot com&gt;</span>
<a name="l00006"></a>00006 <span class="comment">                                                                               </span>
<a name="l00007"></a>00007 <span class="comment">    This program is free software; you can redistribute it and/or modify</span>
<a name="l00008"></a>00008 <span class="comment">    it under the terms of Version 2 of the GNU General Public License</span>
<a name="l00009"></a>00009 <span class="comment">    as published by the Free Software Foundation;</span>
<a name="l00010"></a>00010 <span class="comment">                                                                               </span>
<a name="l00011"></a>00011 <span class="comment">    This program is distributed in the hope that it will be useful,</span>
<a name="l00012"></a>00012 <span class="comment">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00013"></a>00013 <span class="comment">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00014"></a>00014 <span class="comment">    GNU General Public License for more details.</span>
<a name="l00015"></a>00015 <span class="comment">                                                                               </span>
<a name="l00016"></a>00016 <span class="comment">    You should have received a copy of the GNU General Public License</span>
<a name="l00017"></a>00017 <span class="comment">    along with this program; if not, write to the Free Software</span>
<a name="l00018"></a>00018 <span class="comment">    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.                */</span>
<a name="l00019"></a>00019 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00020"></a>00020 
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;linux/ctype.h&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;linux/kernel.h&gt;</span>
<a name="l00025"></a>00025 <span class="comment">//#include &lt;linux/interrupt.h&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;linux/pci.h&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;linux/time.h&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;linux/interrupt.h&gt;</span>       
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;linux/init.h&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;linux/timex.h&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;linux/vmalloc.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;linux/mm.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;linux/moduleparam.h&gt;</span>
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;linux/proc_fs.h&gt;</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;asm/uaccess.h&gt;</span>  <span class="comment">/* VERIFY_READ|WRITE */</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;asm/apic.h&gt;</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="acq200__debug_8h.html">acq200_debug.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="acq200_8h.html" title="internal header file for acq200 Linux PCI host driver.">acq200.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="acq200__minors_8h.html" title="minor device encoding">acq200_minors.h</a>&quot;</span>
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 
<a name="l00046"></a><a class="code" href="acq200__if_8c.html#af8bcaabb7ffb2fa4a9797146ece97bc1">00046</a> <span class="keyword">static</span> ssize_t <a class="code" href="acq200__if_8c.html#af8bcaabb7ffb2fa4a9797146ece97bc1">show_heartbeat</a>(
<a name="l00047"></a>00047         <span class="keyword">struct</span> <a class="code" href="structAcq200Path.html#a1880232de8f511a0022cd1001fa026c7" title="customisation for this node.">device</a> *dev,
<a name="l00048"></a>00048         <span class="keyword">struct</span> device_attribute *attr,
<a name="l00049"></a>00049         <span class="keywordtype">char</span> *buf)
<a name="l00050"></a>00050 {
<a name="l00051"></a>00051         <span class="keyword">struct </span><a class="code" href="structAcq200Device.html" title="device descriptor, one per device">Acq200Device</a> *device = <a class="code" href="acq200_8c.html#a8996c00a06d36d6eb7bd46a96a06d0c6">acq200_lookupDevice</a>(dev);
<a name="l00052"></a>00052 
<a name="l00053"></a>00053         <span class="keywordflow">if</span> (device != 0){
<a name="l00054"></a>00054                 <span class="keywordflow">return</span> sprintf(buf, <span class="stringliteral">&quot;%d\n&quot;</span>, <a class="code" href="acq200_8h.html#a20342da936753e6b4d5f472d91e5dac7">acq200_getHeartbeat</a>(device));
<a name="l00055"></a>00055         }<span class="keywordflow">else</span>{
<a name="l00056"></a>00056                 <span class="keywordflow">return</span> -ENODEV;
<a name="l00057"></a>00057         }
<a name="l00058"></a>00058 }
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 <span class="keyword">static</span> <a class="code" href="acq200__bigbuf__alloc_8c.html#a7687c444c1991e84007a83442f646c5e">DEVICE_ATTR</a>(heartbeat, S_IRUGO, <a class="code" href="acq200__if_8c.html#af8bcaabb7ffb2fa4a9797146ece97bc1">show_heartbeat</a>, 0);
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 
<a name="l00063"></a>00063 <span class="comment">/* from getBoards.pm ..</span>
<a name="l00064"></a>00064 <span class="comment">        if ( $refbrec-&gt;{fun} &gt;= 72 &amp;&amp; $refbrec-&gt;{fun} &lt;= 120 ){</span>
<a name="l00065"></a>00065 <span class="comment"># works for CPV5350 in Schroff backplane</span>
<a name="l00066"></a>00066 <span class="comment">            $refbrec-&gt;{lognum} = 9-($refbrec-&gt;{fun}/8-8);</span>
<a name="l00067"></a>00067 <span class="comment">#           print &quot;getSlotBoardNum() returns $refbrec-&gt;{lognum}\n&quot;;</span>
<a name="l00068"></a>00068 <span class="comment">        }else{</span>
<a name="l00069"></a>00069 <span class="comment">            die &quot;Slot addressing scheme failed&quot;;</span>
<a name="l00070"></a>00070 <span class="comment">        }</span>
<a name="l00071"></a>00071 <span class="comment">    }</span>
<a name="l00072"></a>00072 <span class="comment">*/</span>
<a name="l00073"></a>00073 
<a name="l00074"></a><a class="code" href="acq200__if_8c.html#a629fda69b261cac058b6f8b13fbdf619">00074</a> <span class="keywordtype">int</span> <a class="code" href="acq200_8h.html#a629fda69b261cac058b6f8b13fbdf619">acq200_get_cpci_slot</a>(<span class="keyword">struct</span> <a class="code" href="structAcq200Device.html#a8f801e5f490ffef5e7bd08f4a29c9d24" title="linux pci generic.">pci_dev</a> * <a class="code" href="structAcq200Device.html#a8f801e5f490ffef5e7bd08f4a29c9d24" title="linux pci generic.">pci_dev</a>)
<a name="l00075"></a>00075 {
<a name="l00076"></a>00076         <a class="code" href="local_8h.html#ae0a7c37f5a766b8e881b7ca59f579d01">u32</a> devfn =  pci_dev-&gt;devfn;
<a name="l00077"></a>00077         <span class="keywordtype">int</span> slot = -1;
<a name="l00078"></a>00078 
<a name="l00079"></a>00079         <span class="keywordflow">if</span> (devfn &gt;= 72 &amp;&amp; devfn &lt;= 120){
<a name="l00080"></a>00080                 slot = 9 - (devfn/8 -8);                        
<a name="l00081"></a>00081         }
<a name="l00082"></a>00082         <span class="keywordflow">return</span> slot;    
<a name="l00083"></a>00083 }
<a name="l00084"></a><a class="code" href="acq200__if_8c.html#aa0398cc78b17c9eff0e97227d276a14d">00084</a> <span class="keyword">static</span> ssize_t <a class="code" href="acq200__if_8c.html#aa0398cc78b17c9eff0e97227d276a14d">show_cpci_slot</a>(
<a name="l00085"></a>00085         <span class="keyword">struct</span> device *dev,
<a name="l00086"></a>00086         <span class="keyword">struct</span> device_attribute *attr,
<a name="l00087"></a>00087         <span class="keywordtype">char</span> *buf)
<a name="l00088"></a>00088 {
<a name="l00089"></a>00089         <span class="keyword">struct </span><a class="code" href="structAcq200Device.html" title="device descriptor, one per device">Acq200Device</a> *device = <a class="code" href="acq200_8c.html#a8996c00a06d36d6eb7bd46a96a06d0c6">acq200_lookupDevice</a>(dev);
<a name="l00090"></a>00090 
<a name="l00091"></a>00091         <span class="keywordflow">if</span> (device != 0){               
<a name="l00092"></a>00092                 <span class="keywordflow">return</span> sprintf(buf, <span class="stringliteral">&quot;%d\n&quot;</span>, 
<a name="l00093"></a>00093                         <a class="code" href="acq200_8h.html#a629fda69b261cac058b6f8b13fbdf619">acq200_get_cpci_slot</a>(device-&gt;<a class="code" href="structAcq200Device.html#a8f801e5f490ffef5e7bd08f4a29c9d24" title="linux pci generic.">pci_dev</a>));
<a name="l00094"></a>00094         }<span class="keywordflow">else</span>{
<a name="l00095"></a>00095                 <span class="keywordflow">return</span> -ENODEV;
<a name="l00096"></a>00096         }
<a name="l00097"></a>00097 }
<a name="l00098"></a>00098 
<a name="l00099"></a>00099 <span class="keyword">static</span> <a class="code" href="acq200__bigbuf__alloc_8c.html#a7687c444c1991e84007a83442f646c5e">DEVICE_ATTR</a>(cpci_slot, S_IRUGO, <a class="code" href="acq200__if_8c.html#aa0398cc78b17c9eff0e97227d276a14d">show_cpci_slot</a>, 0);
<a name="l00100"></a>00100 
<a name="l00101"></a><a class="code" href="acq200__if_8c.html#ac06a324fb7b1c4e354795cc3c90f6cee">00101</a> <span class="keyword">static</span> ssize_t <a class="code" href="acq200__if_8c.html#ac06a324fb7b1c4e354795cc3c90f6cee">show_buffer_AB_busy_mutex</a>(
<a name="l00102"></a>00102                 <span class="keyword">struct</span> device *dev,
<a name="l00103"></a>00103                 <span class="keyword">struct</span> device_attribute *attr,
<a name="l00104"></a>00104                 <span class="keywordtype">char</span> *buf)
<a name="l00105"></a>00105 {
<a name="l00106"></a>00106         <span class="keyword">struct </span><a class="code" href="structAcq200Device.html" title="device descriptor, one per device">Acq200Device</a> *device = <a class="code" href="acq200_8c.html#a8996c00a06d36d6eb7bd46a96a06d0c6">acq200_lookupDevice</a>(dev);
<a name="l00107"></a>00107 
<a name="l00108"></a>00108         <span class="keywordflow">if</span> (device != 0){
<a name="l00109"></a>00109                 <span class="keywordtype">int</span> rc = down_trylock(&amp;device-&gt;<a class="code" href="structAcq200Device.html#a2c78154456da7dbb1f0390d2abf7cc93">buffer_AB_busy_mutex</a>);
<a name="l00110"></a>00110                 <span class="keywordflow">if</span> (rc == 0){
<a name="l00111"></a>00111                         up(&amp;device-&gt;<a class="code" href="structAcq200Device.html#a2c78154456da7dbb1f0390d2abf7cc93">buffer_AB_busy_mutex</a>);
<a name="l00112"></a>00112                 }
<a name="l00113"></a>00113                 <span class="keywordflow">return</span> sprintf(buf, <span class="stringliteral">&quot;%d\n&quot;</span>, rc);
<a name="l00114"></a>00114         }<span class="keywordflow">else</span>{
<a name="l00115"></a>00115                 <span class="keywordflow">return</span> -ENODEV;
<a name="l00116"></a>00116         }
<a name="l00117"></a>00117 }
<a name="l00118"></a>00118 
<a name="l00119"></a>00119 <span class="keyword">static</span> <a class="code" href="acq200__bigbuf__alloc_8c.html#a7687c444c1991e84007a83442f646c5e">DEVICE_ATTR</a>(<a class="code" href="structAcq200Device.html#a2c78154456da7dbb1f0390d2abf7cc93">buffer_AB_busy_mutex</a>, S_IRUGO, <a class="code" href="acq200__if_8c.html#ac06a324fb7b1c4e354795cc3c90f6cee">show_buffer_AB_busy_mutex</a>, 0);
<a name="l00120"></a>00120 
<a name="l00121"></a><a class="code" href="acq200__if_8c.html#ad284e0fbb913f3cdc0628dc3266381bf">00121</a> <span class="keyword">static</span> ssize_t <a class="code" href="acq200__if_8c.html#ad284e0fbb913f3cdc0628dc3266381bf">show_interrupt_count</a>(
<a name="l00122"></a>00122         <span class="keyword">struct</span> device *dev,
<a name="l00123"></a>00123         <span class="keyword">struct</span> device_attribute *attr,
<a name="l00124"></a>00124         <span class="keywordtype">char</span> *buf)
<a name="l00125"></a>00125 {
<a name="l00126"></a>00126         <span class="keyword">struct </span><a class="code" href="structAcq200Device.html" title="device descriptor, one per device">Acq200Device</a> *device = <a class="code" href="acq200_8c.html#a8996c00a06d36d6eb7bd46a96a06d0c6">acq200_lookupDevice</a>(dev);
<a name="l00127"></a>00127 
<a name="l00128"></a>00128         <span class="keywordflow">if</span> (device != 0){
<a name="l00129"></a>00129                 <span class="keywordflow">return</span> sprintf(buf, <span class="stringliteral">&quot;%d %d %d\n&quot;</span>, 
<a name="l00130"></a>00130                                device-&gt;<a class="code" href="structAcq200Device.html#aad5dbefa1409e4676ae1b22a91465625">interrupt_count</a>[0],
<a name="l00131"></a>00131                                device-&gt;<a class="code" href="structAcq200Device.html#aad5dbefa1409e4676ae1b22a91465625">interrupt_count</a>[1],
<a name="l00132"></a>00132                                device-&gt;<a class="code" href="structAcq200Device.html#aad5dbefa1409e4676ae1b22a91465625">interrupt_count</a>[2]
<a name="l00133"></a>00133                         );
<a name="l00134"></a>00134         }<span class="keywordflow">else</span>{
<a name="l00135"></a>00135                 <span class="keywordflow">return</span> -ENODEV;
<a name="l00136"></a>00136         }
<a name="l00137"></a>00137 }
<a name="l00138"></a>00138 
<a name="l00139"></a>00139 <span class="keyword">static</span> <a class="code" href="acq200__bigbuf__alloc_8c.html#a7687c444c1991e84007a83442f646c5e">DEVICE_ATTR</a>(<a class="code" href="structAcq200Device.html#aad5dbefa1409e4676ae1b22a91465625">interrupt_count</a>, S_IRUGO, <a class="code" href="acq200__if_8c.html#ad284e0fbb913f3cdc0628dc3266381bf">show_interrupt_count</a>, 0);
<a name="l00140"></a>00140 
<a name="l00141"></a><a class="code" href="acq200__if_8c.html#a036bfd84f9b21fd89a20cf0a4a8b5dd5">00141</a> <span class="keyword">static</span> ssize_t <a class="code" href="acq200__if_8c.html#a036bfd84f9b21fd89a20cf0a4a8b5dd5">show_host_pa</a>(
<a name="l00142"></a>00142         <span class="keyword">struct</span> device *dev, 
<a name="l00143"></a>00143         <span class="keyword">struct</span> device_attribute *attr,
<a name="l00144"></a>00144         <span class="keywordtype">char</span> *buf)
<a name="l00145"></a>00145 {
<a name="l00146"></a>00146         <span class="keyword">struct </span><a class="code" href="structAcq200Device.html" title="device descriptor, one per device">Acq200Device</a> *device = <a class="code" href="acq200_8c.html#a8996c00a06d36d6eb7bd46a96a06d0c6">acq200_lookupDevice</a>(dev);
<a name="l00147"></a>00147 
<a name="l00148"></a>00148         <span class="keywordflow">if</span> (device != 0){
<a name="l00149"></a>00149                 <span class="keywordflow">return</span> sprintf(buf, <span class="stringliteral">&quot;0x%08x\n&quot;</span>, device-&gt;<a class="code" href="structAcq200Device.html#a4e7aeb67c6f8979eee03c8c382cffc14" title="use for LLC">dma_buf</a>.<a class="code" href="structDmaBuf.html#abac2669718be53788e8b3b3a836bc76d">pa</a>);
<a name="l00150"></a>00150         }<span class="keywordflow">else</span>{
<a name="l00151"></a>00151                 <span class="keywordflow">return</span> -ENODEV;
<a name="l00152"></a>00152         }
<a name="l00153"></a>00153 }
<a name="l00154"></a>00154 
<a name="l00155"></a>00155 <span class="keyword">static</span> <a class="code" href="acq200__bigbuf__alloc_8c.html#a7687c444c1991e84007a83442f646c5e">DEVICE_ATTR</a>(host_pa, S_IRUGO, <a class="code" href="acq200__if_8c.html#a036bfd84f9b21fd89a20cf0a4a8b5dd5">show_host_pa</a>, 0);
<a name="l00156"></a>00156 
<a name="l00157"></a><a class="code" href="acq200__if_8c.html#a5a6f5d6eb6cca36a19af8421292146a8">00157</a> <span class="keyword">static</span> ssize_t <a class="code" href="acq200__if_8c.html#a5a6f5d6eb6cca36a19af8421292146a8">show_host_len</a>(
<a name="l00158"></a>00158         <span class="keyword">struct</span> device *dev, 
<a name="l00159"></a>00159         <span class="keyword">struct</span> device_attribute *attr,
<a name="l00160"></a>00160         <span class="keywordtype">char</span> *buf)
<a name="l00161"></a>00161 {
<a name="l00162"></a>00162         <span class="keyword">struct </span><a class="code" href="structAcq200Device.html" title="device descriptor, one per device">Acq200Device</a> *device = <a class="code" href="acq200_8c.html#a8996c00a06d36d6eb7bd46a96a06d0c6">acq200_lookupDevice</a>(dev);
<a name="l00163"></a>00163 
<a name="l00164"></a>00164         <span class="keywordflow">if</span> (device != 0){
<a name="l00165"></a>00165                 <span class="keywordflow">return</span> sprintf(buf, <span class="stringliteral">&quot;%d\n&quot;</span>, <a class="code" href="acq200_8h.html#adb330d36ca3a1492c310f0747783b893">dma_buf_len</a>(&amp;device-&gt;<a class="code" href="structAcq200Device.html#a4e7aeb67c6f8979eee03c8c382cffc14" title="use for LLC">dma_buf</a>));
<a name="l00166"></a>00166         }<span class="keywordflow">else</span>{
<a name="l00167"></a>00167                 <span class="keywordflow">return</span> -ENODEV;
<a name="l00168"></a>00168         }
<a name="l00169"></a>00169 }
<a name="l00170"></a>00170 
<a name="l00171"></a>00171 <span class="keyword">static</span> <a class="code" href="acq200__bigbuf__alloc_8c.html#a7687c444c1991e84007a83442f646c5e">DEVICE_ATTR</a>(host_len, S_IRUGO, <a class="code" href="acq200__if_8c.html#a5a6f5d6eb6cca36a19af8421292146a8">show_host_len</a>, 0);
<a name="l00172"></a>00172 
<a name="l00173"></a><a class="code" href="acq200__if_8c.html#aefcfa8d276abdda3a172aefd202e00eb">00173</a> <span class="keyword">static</span> ssize_t <a class="code" href="acq200__if_8c.html#aefcfa8d276abdda3a172aefd202e00eb">show_llhost_pa</a>(
<a name="l00174"></a>00174         <span class="keyword">struct</span> device *dev,
<a name="l00175"></a>00175         <span class="keyword">struct</span> device_attribute *attr,
<a name="l00176"></a>00176         <span class="keywordtype">char</span> *buf)
<a name="l00177"></a>00177 {
<a name="l00178"></a>00178         <span class="keyword">struct </span><a class="code" href="structAcq200Device.html" title="device descriptor, one per device">Acq200Device</a> *device = <a class="code" href="acq200_8c.html#a8996c00a06d36d6eb7bd46a96a06d0c6">acq200_lookupDevice</a>(dev);
<a name="l00179"></a>00179 
<a name="l00180"></a>00180         <span class="keywordflow">if</span> (device != 0){
<a name="l00181"></a>00181                 <span class="keywordflow">return</span> sprintf(buf, <span class="stringliteral">&quot;0x%08x\n&quot;</span>, device-&gt;<a class="code" href="structAcq200Device.html#a65eaaf4b4e2507a1d5498ce0007f9c43">llhost_dma_buf</a>.<a class="code" href="structDmaBuf.html#abac2669718be53788e8b3b3a836bc76d">pa</a>);
<a name="l00182"></a>00182         }<span class="keywordflow">else</span>{
<a name="l00183"></a>00183                 <span class="keywordflow">return</span> -ENODEV;
<a name="l00184"></a>00184         }
<a name="l00185"></a>00185 }
<a name="l00186"></a>00186 
<a name="l00187"></a>00187 <span class="keyword">static</span> <a class="code" href="acq200__bigbuf__alloc_8c.html#a7687c444c1991e84007a83442f646c5e">DEVICE_ATTR</a>(llhost_pa, S_IRUGO, <a class="code" href="acq200__if_8c.html#aefcfa8d276abdda3a172aefd202e00eb">show_llhost_pa</a>, 0);
<a name="l00188"></a>00188 
<a name="l00189"></a><a class="code" href="acq200__if_8c.html#aa6c8e24624b7d7dbcf6f036403b37f43">00189</a> <span class="keyword">static</span> ssize_t <a class="code" href="acq200__if_8c.html#aa6c8e24624b7d7dbcf6f036403b37f43">show_llhost_len</a>(
<a name="l00190"></a>00190         <span class="keyword">struct</span> device *dev,
<a name="l00191"></a>00191         <span class="keyword">struct</span> device_attribute *attr,
<a name="l00192"></a>00192         <span class="keywordtype">char</span> *buf)
<a name="l00193"></a>00193 {
<a name="l00194"></a>00194         <span class="keyword">struct </span><a class="code" href="structAcq200Device.html" title="device descriptor, one per device">Acq200Device</a> *device = <a class="code" href="acq200_8c.html#a8996c00a06d36d6eb7bd46a96a06d0c6">acq200_lookupDevice</a>(dev);
<a name="l00195"></a>00195 
<a name="l00196"></a>00196         <span class="keywordflow">if</span> (device != 0){
<a name="l00197"></a>00197                 <span class="keywordflow">return</span> sprintf(buf, <span class="stringliteral">&quot;%d\n&quot;</span>, <a class="code" href="acq200_8h.html#adb330d36ca3a1492c310f0747783b893">dma_buf_len</a>(&amp;device-&gt;<a class="code" href="structAcq200Device.html#a65eaaf4b4e2507a1d5498ce0007f9c43">llhost_dma_buf</a>));
<a name="l00198"></a>00198         }<span class="keywordflow">else</span>{
<a name="l00199"></a>00199                 <span class="keywordflow">return</span> -ENODEV;
<a name="l00200"></a>00200         }
<a name="l00201"></a>00201 }
<a name="l00202"></a>00202 
<a name="l00203"></a>00203 <span class="keyword">static</span> <a class="code" href="acq200__bigbuf__alloc_8c.html#a7687c444c1991e84007a83442f646c5e">DEVICE_ATTR</a>(llhost_len, S_IRUGO, <a class="code" href="acq200__if_8c.html#aa6c8e24624b7d7dbcf6f036403b37f43">show_llhost_len</a>, 0);
<a name="l00204"></a>00204 
<a name="l00205"></a>00205 
<a name="l00206"></a><a class="code" href="acq200__if_8c.html#ac9304ec0916a702580d1d434112ae019">00206</a> <span class="keyword">static</span> ssize_t <a class="code" href="acq200__if_8c.html#ac9304ec0916a702580d1d434112ae019">show_available_input_channels</a>(
<a name="l00207"></a>00207         <span class="keyword">struct</span> device *dev, 
<a name="l00208"></a>00208         <span class="keyword">struct</span> device_attribute *attr,
<a name="l00209"></a>00209         <span class="keywordtype">char</span> *buf)
<a name="l00210"></a>00210 {
<a name="l00211"></a>00211         <span class="keyword">struct </span><a class="code" href="structAcq200Device.html" title="device descriptor, one per device">Acq200Device</a> *device = <a class="code" href="acq200_8c.html#a8996c00a06d36d6eb7bd46a96a06d0c6">acq200_lookupDevice</a>(dev);
<a name="l00212"></a>00212 
<a name="l00213"></a>00213         <span class="keywordflow">if</span> (device != 0){
<a name="l00214"></a>00214                 <span class="keywordflow">return</span> sprintf(buf, <span class="stringliteral">&quot;%d\n&quot;</span>, device-&gt;<a class="code" href="structAcq200Device.html#a64b58781912381e9a8fbc4b88a08d791">input_channels</a>.<a class="code" href="structAcq200Device_1_1CHANNEL__INFO.html#a8f9176afd8f0ed9db81ef5ae5faf9cb3">nchannels</a>);
<a name="l00215"></a>00215         }<span class="keywordflow">else</span>{
<a name="l00216"></a>00216                 <span class="keywordflow">return</span> -ENODEV;
<a name="l00217"></a>00217         }
<a name="l00218"></a>00218 }
<a name="l00219"></a>00219 
<a name="l00220"></a>00220 <span class="keyword">static</span> <a class="code" href="acq200__bigbuf__alloc_8c.html#a7687c444c1991e84007a83442f646c5e">DEVICE_ATTR</a>(available_input_channels, S_IRUGO, 
<a name="l00221"></a>00221         <a class="code" href="acq200__if_8c.html#ac9304ec0916a702580d1d434112ae019">show_available_input_channels</a>, 0);
<a name="l00222"></a>00222 
<a name="l00223"></a>00223 
<a name="l00224"></a><a class="code" href="acq200__if_8c.html#a6f89f03385c5ee429e29c7a270112b4b">00224</a> <span class="keyword">static</span> ssize_t <a class="code" href="acq200__if_8c.html#a6f89f03385c5ee429e29c7a270112b4b">show_available_output_channels</a>(
<a name="l00225"></a>00225         <span class="keyword">struct</span> device *dev,
<a name="l00226"></a>00226         <span class="keyword">struct</span> device_attribute *attr,
<a name="l00227"></a>00227         <span class="keywordtype">char</span> *buf)
<a name="l00228"></a>00228 {
<a name="l00229"></a>00229         <span class="keyword">struct </span><a class="code" href="structAcq200Device.html" title="device descriptor, one per device">Acq200Device</a> *device = <a class="code" href="acq200_8c.html#a8996c00a06d36d6eb7bd46a96a06d0c6">acq200_lookupDevice</a>(dev);
<a name="l00230"></a>00230 
<a name="l00231"></a>00231         <span class="keywordflow">if</span> (device != 0){
<a name="l00232"></a>00232                 <span class="keywordflow">return</span> sprintf(buf, <span class="stringliteral">&quot;%d\n&quot;</span>, device-&gt;<a class="code" href="structAcq200Device.html#a8c807f090566ebff9deeeec11dc79d1f">output_channels</a>.<a class="code" href="structAcq200Device_1_1CHANNEL__INFO.html#a8f9176afd8f0ed9db81ef5ae5faf9cb3">nchannels</a>);
<a name="l00233"></a>00233         }<span class="keywordflow">else</span>{
<a name="l00234"></a>00234                 <span class="keywordflow">return</span> -ENODEV;
<a name="l00235"></a>00235         }
<a name="l00236"></a>00236 }
<a name="l00237"></a>00237 
<a name="l00238"></a>00238 <span class="keyword">static</span> <a class="code" href="acq200__bigbuf__alloc_8c.html#a7687c444c1991e84007a83442f646c5e">DEVICE_ATTR</a>(available_output_channels, S_IRUGO,
<a name="l00239"></a>00239                    <a class="code" href="acq200__if_8c.html#a6f89f03385c5ee429e29c7a270112b4b">show_available_output_channels</a>, 0);
<a name="l00240"></a>00240 
<a name="l00241"></a>00241 
<a name="l00242"></a><a class="code" href="acq200__if_8c.html#a3b4e9b75c4c1e8fe17c6f1ba15cb6800">00242</a> <span class="keyword">static</span> ssize_t <a class="code" href="acq200__if_8c.html#a3b4e9b75c4c1e8fe17c6f1ba15cb6800">dumpDmaBuf</a>(
<a name="l00243"></a>00243         <span class="keyword">struct</span> <a class="code" href="structDmaBuf.html">DmaBuf</a> *<a class="code" href="structAcq200Device.html#a4e7aeb67c6f8979eee03c8c382cffc14" title="use for LLC">dma_buf</a>, <span class="keywordtype">char</span> *buf, <span class="keywordtype">int</span> maxbuf, <span class="keyword">const</span> <span class="keywordtype">char</span>* <span class="keywordtype">id</span>)
<a name="l00244"></a>00244 {
<a name="l00245"></a>00245         <span class="keywordflow">return</span> snprintf(buf, maxbuf, <span class="stringliteral">&quot;%10s:%d %p 0x%08x len %d\n&quot;</span>,
<a name="l00246"></a>00246                         <span class="keywordtype">id</span>,
<a name="l00247"></a>00247                         dma_buf-&gt;<a class="code" href="structDmaBuf.html#a5959a6bacf5e06df4749d836c7676298">order</a>, dma_buf-&gt;<a class="code" href="structDmaBuf.html#aa0590c89317d41622971d58fd3275a1e">va</a>, dma_buf-&gt;<a class="code" href="structDmaBuf.html#abac2669718be53788e8b3b3a836bc76d">pa</a>,
<a name="l00248"></a>00248                         <a class="code" href="acq200_8h.html#adb330d36ca3a1492c310f0747783b893">dma_buf_len</a>(dma_buf));
<a name="l00249"></a>00249 }
<a name="l00250"></a>00250 
<a name="l00251"></a><a class="code" href="acq200__if_8c.html#a5f62e864d2152041aca1503327684fe6">00251</a> <span class="keyword">static</span> ssize_t <a class="code" href="acq200__if_8c.html#a5f62e864d2152041aca1503327684fe6">show_buffers</a>(
<a name="l00252"></a>00252         <span class="keyword">struct</span> device *dev,
<a name="l00253"></a>00253         <span class="keyword">struct</span> device_attribute *attr,
<a name="l00254"></a>00254         <span class="keywordtype">char</span> *buf)
<a name="l00255"></a>00255 {
<a name="l00256"></a>00256         <span class="keyword">struct </span><a class="code" href="structAcq200Device.html" title="device descriptor, one per device">Acq200Device</a> *device = <a class="code" href="acq200_8c.html#a8996c00a06d36d6eb7bd46a96a06d0c6">acq200_lookupDevice</a>(dev);
<a name="l00257"></a>00257         <span class="keywordtype">int</span> cc = <a class="code" href="acq200__if_8c.html#a3b4e9b75c4c1e8fe17c6f1ba15cb6800">dumpDmaBuf</a>(&amp;device-&gt;<a class="code" href="structAcq200Device.html#a4e7aeb67c6f8979eee03c8c382cffc14" title="use for LLC">dma_buf</a>, buf, 80, <span class="stringliteral">&quot;dma_buf&quot;</span>);      
<a name="l00258"></a>00258         <span class="keywordflow">if</span> (device-&gt;<a class="code" href="structAcq200Device.html#ae55e639729a0d2f18130ea92994b1595">AB</a>[0].<a class="code" href="structDmaBuf.html#aa0590c89317d41622971d58fd3275a1e">va</a>){
<a name="l00259"></a>00259                 cc += <a class="code" href="acq200__if_8c.html#a3b4e9b75c4c1e8fe17c6f1ba15cb6800">dumpDmaBuf</a>(&amp;device-&gt;<a class="code" href="structAcq200Device.html#ae55e639729a0d2f18130ea92994b1595">AB</a>[0], buf+cc, 80, <span class="stringliteral">&quot;buffer A&quot;</span>);
<a name="l00260"></a>00260         }
<a name="l00261"></a>00261         <span class="keywordflow">if</span> (device-&gt;<a class="code" href="structAcq200Device.html#ae55e639729a0d2f18130ea92994b1595">AB</a>[1].<a class="code" href="structDmaBuf.html#aa0590c89317d41622971d58fd3275a1e">va</a>){
<a name="l00262"></a>00262                 cc += <a class="code" href="acq200__if_8c.html#a3b4e9b75c4c1e8fe17c6f1ba15cb6800">dumpDmaBuf</a>(&amp;device-&gt;<a class="code" href="structAcq200Device.html#ae55e639729a0d2f18130ea92994b1595">AB</a>[1], buf+cc, 80, <span class="stringliteral">&quot;buffer B&quot;</span>);
<a name="l00263"></a>00263         }
<a name="l00264"></a>00264         <span class="keywordflow">return</span> cc;
<a name="l00265"></a>00265 }
<a name="l00266"></a>00266 
<a name="l00267"></a>00267 
<a name="l00268"></a>00268 <span class="keyword">static</span> <a class="code" href="acq200__bigbuf__alloc_8c.html#a7687c444c1991e84007a83442f646c5e">DEVICE_ATTR</a>(buffers, S_IRUGO, <a class="code" href="acq200__if_8c.html#a5f62e864d2152041aca1503327684fe6">show_buffers</a>, 0);
<a name="l00269"></a>00269 
<a name="l00270"></a><a class="code" href="acq200__if_8c.html#ab8e2ec81e2ebf4af7e93323b47f8ef79">00270</a> <span class="keywordtype">void</span> <a class="code" href="acq200_8h.html#ab8e2ec81e2ebf4af7e93323b47f8ef79">acq200_device_create_file</a>(
<a name="l00271"></a>00271         <span class="keyword">struct</span> device * dev, <span class="keyword">struct</span> device_attribute * attr,
<a name="l00272"></a>00272         <span class="keyword">const</span> <span class="keywordtype">char</span> *file, <span class="keywordtype">int</span> line)
<a name="l00273"></a>00273 {
<a name="l00274"></a>00274         <span class="keywordflow">if</span> (device_create_file(dev, attr)){
<a name="l00275"></a>00275                 <a class="code" href="acq200__debug_8h.html#abdc0ddb6c825c951cdc8e45b53459445">err</a>(<span class="stringliteral">&quot;%s:%d device_create_file&quot;</span>, file, line);
<a name="l00276"></a>00276         }
<a name="l00277"></a>00277 }
<a name="l00278"></a>00278 
<a name="l00279"></a>00279 
<a name="l00280"></a><a class="code" href="acq200__if_8c.html#ac9914252777b9cc3fc2583fcaa72daa9">00280</a> <span class="keywordtype">void</span> <a class="code" href="acq200_8h.html#ac9914252777b9cc3fc2583fcaa72daa9">acq200_create_sysfs_device</a>(<span class="keyword">struct</span> device *dev)
<a name="l00281"></a>00281 {
<a name="l00282"></a>00282         <a class="code" href="acq200__debug_8h.html#aa91fbb7a1131706ff77fe51dd9903199">dbg</a>(1, <span class="stringliteral">&quot;01&quot;</span>);
<a name="l00283"></a>00283         <a class="code" href="acq200_8h.html#a23f488df63b98c0c8a440ef9334d7728">DEVICE_CREATE_FILE</a>(dev, &amp;dev_attr_host_pa);
<a name="l00284"></a>00284         <a class="code" href="acq200_8h.html#a23f488df63b98c0c8a440ef9334d7728">DEVICE_CREATE_FILE</a>(dev, &amp;dev_attr_host_len);
<a name="l00285"></a>00285         <a class="code" href="acq200_8h.html#a23f488df63b98c0c8a440ef9334d7728">DEVICE_CREATE_FILE</a>(dev, &amp;dev_attr_llhost_pa);
<a name="l00286"></a>00286         <a class="code" href="acq200_8h.html#a23f488df63b98c0c8a440ef9334d7728">DEVICE_CREATE_FILE</a>(dev, &amp;dev_attr_llhost_len);
<a name="l00287"></a>00287         <a class="code" href="acq200_8h.html#a23f488df63b98c0c8a440ef9334d7728">DEVICE_CREATE_FILE</a>(dev, &amp;dev_attr_heartbeat);
<a name="l00288"></a>00288         <a class="code" href="acq200_8h.html#a23f488df63b98c0c8a440ef9334d7728">DEVICE_CREATE_FILE</a>(dev, &amp;dev_attr_cpci_slot);
<a name="l00289"></a>00289         <a class="code" href="acq200_8h.html#a23f488df63b98c0c8a440ef9334d7728">DEVICE_CREATE_FILE</a>(dev, &amp;dev_attr_buffer_AB_busy_mutex);
<a name="l00290"></a>00290         <a class="code" href="acq200_8h.html#a23f488df63b98c0c8a440ef9334d7728">DEVICE_CREATE_FILE</a>(dev, &amp;dev_attr_interrupt_count);
<a name="l00291"></a>00291 
<a name="l00292"></a>00292         <a class="code" href="acq200_8h.html#a23f488df63b98c0c8a440ef9334d7728">DEVICE_CREATE_FILE</a>(dev, &amp;dev_attr_available_input_channels);
<a name="l00293"></a>00293         <a class="code" href="acq200_8h.html#a23f488df63b98c0c8a440ef9334d7728">DEVICE_CREATE_FILE</a>(dev, &amp;dev_attr_available_output_channels);
<a name="l00294"></a>00294         <a class="code" href="acq200_8h.html#a23f488df63b98c0c8a440ef9334d7728">DEVICE_CREATE_FILE</a>(dev, &amp;dev_attr_buffers);
<a name="l00295"></a>00295         <a class="code" href="acq200__debug_8h.html#aa91fbb7a1131706ff77fe51dd9903199">dbg</a>(1, <span class="stringliteral">&quot;99&quot;</span>);
<a name="l00296"></a>00296 }
<a name="l00297"></a>00297 
<a name="l00298"></a><a class="code" href="acq200__if_8c.html#a5ee5a4dcf3390366a905084bbc25dc51">00298</a> <span class="keywordtype">void</span> <a class="code" href="acq200_8h.html#a5ee5a4dcf3390366a905084bbc25dc51">acq200_remove_sysfs_device</a>(<span class="keyword">struct</span> device *dev)
<a name="l00299"></a>00299 {
<a name="l00300"></a>00300         device_remove_file(dev, &amp;dev_attr_host_pa);
<a name="l00301"></a>00301         device_remove_file(dev, &amp;dev_attr_host_len);
<a name="l00302"></a>00302         device_remove_file(dev, &amp;dev_attr_llhost_pa);
<a name="l00303"></a>00303         device_remove_file(dev, &amp;dev_attr_llhost_len);
<a name="l00304"></a>00304         device_remove_file(dev, &amp;dev_attr_heartbeat);
<a name="l00305"></a>00305         device_remove_file(dev, &amp;dev_attr_cpci_slot);
<a name="l00306"></a>00306         device_remove_file(dev, &amp;dev_attr_buffer_AB_busy_mutex);
<a name="l00307"></a>00307         device_remove_file(dev, &amp;dev_attr_interrupt_count);
<a name="l00308"></a>00308 
<a name="l00309"></a>00309         device_remove_file(dev, &amp;dev_attr_available_input_channels);
<a name="l00310"></a>00310         device_remove_file(dev, &amp;dev_attr_available_output_channels);
<a name="l00311"></a>00311         device_remove_file(dev, &amp;dev_attr_buffers);
<a name="l00312"></a>00312 }
<a name="l00313"></a>00313 
<a name="l00314"></a>00314 
<a name="l00315"></a>00315 
<a name="l00316"></a><a class="code" href="acq200__if_8c.html#ad146c86012d79a6f4964ca9d22d8e764">00316</a> <span class="keyword">static</span> ssize_t <a class="code" href="acq200__if_8c.html#ad146c86012d79a6f4964ca9d22d8e764">show_imask</a>(
<a name="l00317"></a>00317         <span class="keyword">struct</span> <a class="code" href="acq200_8h.html#a26d051a455c8adc1c3479a32f29ee40f">CLASS_DEVICE</a> *dev, 
<a name="l00318"></a>00318 #ifndef ORIGINAL_CLASS_DEVICE_INTERFACE
<a name="l00319"></a>00319         <span class="keyword">struct</span> device_attribute *attr, 
<a name="l00320"></a>00320 #endif
<a name="l00321"></a>00321         <span class="keywordtype">char</span>* buf)
<a name="l00322"></a>00322 {
<a name="l00323"></a>00323         <span class="keyword">struct </span><a class="code" href="structAcq200Device.html" title="device descriptor, one per device">Acq200Device</a> *device = <a class="code" href="acq200_8c.html#ad2ab30da3ff5d958582d619962dc56c9">acq200_lookupDeviceFromClass</a>(dev);
<a name="l00324"></a>00324 
<a name="l00325"></a>00325         <span class="keywordflow">if</span> (device != 0){
<a name="l00326"></a>00326                 <span class="keywordflow">return</span> sprintf(buf, <span class="stringliteral">&quot;%s\n&quot;</span>, device-&gt;<a class="code" href="structAcq200Device.html#ad1dcc5b04385134ae3ed5f39a6c7dc75">imask</a>);
<a name="l00327"></a>00327         }<span class="keywordflow">else</span>{
<a name="l00328"></a>00328                 <span class="keywordflow">return</span> -ENODEV;
<a name="l00329"></a>00329         }
<a name="l00330"></a>00330 }
<a name="l00331"></a>00331 
<a name="l00332"></a><a class="code" href="acq200__if_8c.html#a5569e78934c501945d0b04b40a2e4baa">00332</a> <span class="keyword">static</span> ssize_t <a class="code" href="acq200__if_8c.html#a5569e78934c501945d0b04b40a2e4baa">store_imask</a>(
<a name="l00333"></a>00333         <span class="keyword">struct</span> <a class="code" href="acq200_8h.html#a26d051a455c8adc1c3479a32f29ee40f">CLASS_DEVICE</a> *dev, 
<a name="l00334"></a>00334 #ifndef ORIGINAL_CLASS_DEVICE_INTERFACE
<a name="l00335"></a>00335         <span class="keyword">struct</span> device_attribute *attr, 
<a name="l00336"></a>00336 #endif
<a name="l00337"></a>00337         <span class="keyword">const</span> <span class="keywordtype">char</span> *buf, <span class="keywordtype">size_t</span> count)
<a name="l00338"></a>00338 {
<a name="l00339"></a>00339         <span class="keyword">struct </span><a class="code" href="structAcq200Device.html" title="device descriptor, one per device">Acq200Device</a> *device = <a class="code" href="acq200_8c.html#ad2ab30da3ff5d958582d619962dc56c9">acq200_lookupDeviceFromClass</a>(dev);
<a name="l00340"></a>00340 
<a name="l00341"></a>00341         <span class="keywordflow">if</span> (device != 0){
<a name="l00342"></a>00342                 <span class="keywordflow">if</span> (strncmp(buf, <span class="stringliteral">&quot;LAPIC&quot;</span>, 5) == 0){
<a name="l00343"></a>00343                         disable_local_APIC();
<a name="l00344"></a>00344                 }<span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(buf, <span class="stringliteral">&quot;LOC&quot;</span>, 3) == 0){
<a name="l00345"></a>00345                         <a class="code" href="acq200_8h.html#af113c0e6c67857dcbd33c7ed1cd8874b">acq200_bkl</a>(device, <a class="code" href="acq200_8h.html#a0b49c45220dcec0da182ffebad16188a">BKL_LOCK</a>);
<a name="l00346"></a>00346                 }<span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(buf, <span class="stringliteral">&quot;000&quot;</span>, 3) == 0 &amp;&amp;
<a name="l00347"></a>00347                                 <a class="code" href="acq200_8h.html#af113c0e6c67857dcbd33c7ed1cd8874b">acq200_bkl</a>(device, <a class="code" href="acq200_8h.html#a1f67431469beff64788636c9cb3f5482">BKL_QUERY</a>)){
<a name="l00348"></a>00348                         <a class="code" href="acq200_8h.html#af113c0e6c67857dcbd33c7ed1cd8874b">acq200_bkl</a>(device, <a class="code" href="acq200_8h.html#ac6a2bbfffb3bb70e385fb983360ca5a1">BKL_UNLOCK</a>);
<a name="l00349"></a>00349                 }<span class="keywordflow">else</span>{
<a name="l00350"></a>00350                         <span class="keywordtype">int</span> ic;
<a name="l00351"></a>00351                         strncpy(device-&gt;<a class="code" href="structAcq200Device.html#ad1dcc5b04385134ae3ed5f39a6c7dc75">imask</a>, buf, NR_IRQS/4);
<a name="l00352"></a>00352                         <span class="keywordflow">for</span> (ic = strlen(device-&gt;<a class="code" href="structAcq200Device.html#ad1dcc5b04385134ae3ed5f39a6c7dc75">imask</a>); ic--; ){
<a name="l00353"></a>00353                                 <span class="keywordflow">if</span> (!isxdigit(device-&gt;<a class="code" href="structAcq200Device.html#ad1dcc5b04385134ae3ed5f39a6c7dc75">imask</a>[ic])){
<a name="l00354"></a>00354                                         device-&gt;<a class="code" href="structAcq200Device.html#ad1dcc5b04385134ae3ed5f39a6c7dc75">imask</a>[ic] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00355"></a>00355                                 }
<a name="l00356"></a>00356                         }
<a name="l00357"></a>00357                         <a class="code" href="acq200_8h.html#acc3e3782f25de2fc52581c56f0a2d8c3" title="unmap remote regs are on device unload">acq200_intsMask</a>(device);
<a name="l00358"></a>00358                 }
<a name="l00359"></a>00359                 <span class="keywordflow">return</span> strlen(buf);
<a name="l00360"></a>00360         }<span class="keywordflow">else</span>{
<a name="l00361"></a>00361                 <span class="keywordflow">return</span> -ENODEV;
<a name="l00362"></a>00362         }
<a name="l00363"></a>00363 }
<a name="l00364"></a>00364 
<a name="l00365"></a>00365 <span class="keyword">static</span> <a class="code" href="acq200_8h.html#abd58cace23040fa5afe2466538564711">CLASS_DEVICE_ATTR</a>(<a class="code" href="structAcq200Device.html#ad1dcc5b04385134ae3ed5f39a6c7dc75">imask</a>, S_IRUGO|S_IWUSR, <a class="code" href="acq200__if_8c.html#ad146c86012d79a6f4964ca9d22d8e764">show_imask</a>, <a class="code" href="acq200__if_8c.html#a5569e78934c501945d0b04b40a2e4baa">store_imask</a>);
<a name="l00366"></a>00366 
<a name="l00367"></a>00367 
<a name="l00368"></a><a class="code" href="acq200__if_8c.html#a98cc74924a898a29f8aa1ad768ed60b8">00368</a> <span class="keyword">static</span> ssize_t <a class="code" href="acq200__if_8c.html#a98cc74924a898a29f8aa1ad768ed60b8">show_dev</a>(
<a name="l00369"></a>00369         <span class="keyword">struct</span> <a class="code" href="acq200_8h.html#a26d051a455c8adc1c3479a32f29ee40f">CLASS_DEVICE</a> *dev, 
<a name="l00370"></a>00370 #ifndef ORIGINAL_CLASS_DEVICE_INTERFACE
<a name="l00371"></a>00371         <span class="keyword">struct</span> device_attribute *attr, 
<a name="l00372"></a>00372 #endif
<a name="l00373"></a>00373         <span class="keywordtype">char</span> *buf)
<a name="l00374"></a>00374 <span class="comment">/* major:minor output for udev. minor is a dummy (we use all of them!) */</span>
<a name="l00375"></a>00375 {
<a name="l00376"></a>00376         <span class="keyword">struct </span><a class="code" href="structAcq200Device.html" title="device descriptor, one per device">Acq200Device</a> *device = <a class="code" href="acq200_8c.html#ad2ab30da3ff5d958582d619962dc56c9">acq200_lookupDeviceFromClass</a>(dev);
<a name="l00377"></a>00377 
<a name="l00378"></a>00378         <span class="keywordflow">if</span> (device){
<a name="l00379"></a>00379                 <span class="keywordflow">return</span> sprintf(buf, <span class="stringliteral">&quot;%d:%d\n&quot;</span>, device-&gt;<a class="code" href="structAcq200Device.html#ab9f472c73ebb18379988925f717a4be5">ldev</a>.<a class="code" href="structAcq200Device_1_1LogicalDev.html#a9cafea203c979f1775adbbbc4542a2b1">major</a>, 0);
<a name="l00380"></a>00380         }<span class="keywordflow">else</span>{
<a name="l00381"></a>00381                 <span class="keywordflow">return</span> -ENODEV;
<a name="l00382"></a>00382         }
<a name="l00383"></a>00383 }
<a name="l00384"></a>00384 
<a name="l00385"></a>00385 
<a name="l00386"></a>00386 <span class="keyword">static</span> <a class="code" href="acq200_8h.html#abd58cace23040fa5afe2466538564711">CLASS_DEVICE_ATTR</a>(dev, S_IRUGO, <a class="code" href="acq200__if_8c.html#a98cc74924a898a29f8aa1ad768ed60b8">show_dev</a>, 0);
<a name="l00387"></a>00387 
<a name="l00388"></a>00388 <span class="preprocessor">#ifdef ORIGINAL_CLASS_DEVICE_INTERFACE</span>
<a name="l00389"></a>00389 <span class="preprocessor"></span><span class="keywordtype">void</span> acq200_class_device_create_file(
<a name="l00390"></a>00390         <span class="keyword">struct</span> class_device * dev, <span class="keyword">struct</span> class_device_attribute * attr,
<a name="l00391"></a>00391         <span class="keyword">const</span> <span class="keywordtype">char</span> *file, <span class="keywordtype">int</span> line)
<a name="l00392"></a>00392 {
<a name="l00393"></a>00393         <span class="keywordflow">if</span> (class_device_create_file(dev, attr)){
<a name="l00394"></a>00394                 <a class="code" href="acq200__debug_8h.html#abdc0ddb6c825c951cdc8e45b53459445">err</a>(<span class="stringliteral">&quot;%s:%d device_create_file&quot;</span>, file, line);
<a name="l00395"></a>00395         }
<a name="l00396"></a>00396 }
<a name="l00397"></a>00397 
<a name="l00398"></a>00398 <span class="preprocessor">#define CLASS_DEVICE_CREATE_FILE(dev, attr) \</span>
<a name="l00399"></a>00399 <span class="preprocessor">        acq200_class_device_create_file(dev, attr, __FILE__, __LINE__)</span>
<a name="l00400"></a>00400 <span class="preprocessor"></span>
<a name="l00401"></a>00401 <span class="keywordtype">void</span> <a class="code" href="acq200_8h.html#a03a6bb8f1bff0cbb82710d96d848e0f3">acq200_create_sysfs_class</a>(<span class="keyword">struct</span> <a class="code" href="structAcq200Device.html" title="device descriptor, one per device">Acq200Device</a> *adev)
<a name="l00402"></a>00402 {
<a name="l00403"></a>00403         <a class="code" href="acq200__debug_8h.html#aa91fbb7a1131706ff77fe51dd9903199">dbg</a>(1, <span class="stringliteral">&quot;01&quot;</span>);
<a name="l00404"></a>00404         <a class="code" href="acq200_8h.html#ac396dda93cfddb97ab4c9865aa4d8b54">CLASS_DEVICE_CREATE_FILE</a>(adev-&gt;<a class="code" href="structAcq200Device.html#a190b71a8087d48a3bf318d7377d41ce3" title="class generic.">class_dev</a>, &amp;class_device_attr_imask);
<a name="l00405"></a>00405         <a class="code" href="acq200_8h.html#ac396dda93cfddb97ab4c9865aa4d8b54">CLASS_DEVICE_CREATE_FILE</a>(adev-&gt;<a class="code" href="structAcq200Device.html#a190b71a8087d48a3bf318d7377d41ce3" title="class generic.">class_dev</a>, &amp;class_device_attr_dev);
<a name="l00406"></a>00406         <a class="code" href="acq200__debug_8h.html#aa91fbb7a1131706ff77fe51dd9903199">dbg</a>(1, <span class="stringliteral">&quot;9&quot;</span>);
<a name="l00407"></a>00407 }
<a name="l00408"></a>00408 
<a name="l00409"></a>00409 <span class="keywordtype">void</span> <a class="code" href="acq200_8h.html#ae729b82245aab78f52842262528f3790">acq200_remove_sysfs_class</a>(<span class="keyword">struct</span> <a class="code" href="structAcq200Device.html" title="device descriptor, one per device">Acq200Device</a> *adev)
<a name="l00410"></a>00410 {
<a name="l00411"></a>00411         class_device_remove_file(adev-&gt;<a class="code" href="structAcq200Device.html#a190b71a8087d48a3bf318d7377d41ce3" title="class generic.">class_dev</a>, &amp;class_device_attr_imask);
<a name="l00412"></a>00412         class_device_remove_file(adev-&gt;<a class="code" href="structAcq200Device.html#a190b71a8087d48a3bf318d7377d41ce3" title="class generic.">class_dev</a>, &amp;class_device_attr_dev);
<a name="l00413"></a>00413 }
<a name="l00414"></a>00414 
<a name="l00415"></a>00415 
<a name="l00416"></a>00416 <span class="preprocessor">#else</span>
<a name="l00417"></a><a class="code" href="acq200__if_8c.html#a03a6bb8f1bff0cbb82710d96d848e0f3">00417</a> <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="acq200_8h.html#a03a6bb8f1bff0cbb82710d96d848e0f3">acq200_create_sysfs_class</a>(<span class="keyword">struct</span> <a class="code" href="structAcq200Device.html" title="device descriptor, one per device">Acq200Device</a>  *adev)
<a name="l00418"></a>00418 {
<a name="l00419"></a>00419         <span class="keywordtype">int</span> rc;
<a name="l00420"></a>00420         <a class="code" href="acq200__debug_8h.html#aa91fbb7a1131706ff77fe51dd9903199">dbg</a>(1, <span class="stringliteral">&quot;01&quot;</span>);
<a name="l00421"></a>00421         <a class="code" href="acq200_8h.html#a23f488df63b98c0c8a440ef9334d7728">DEVICE_CREATE_FILE</a>(adev-&gt;<a class="code" href="structAcq200Device.html#a190b71a8087d48a3bf318d7377d41ce3" title="class generic.">class_dev</a>, &amp;dev_attr_imask);
<a name="l00422"></a>00422         <a class="code" href="acq200_8h.html#a23f488df63b98c0c8a440ef9334d7728">DEVICE_CREATE_FILE</a>(adev-&gt;<a class="code" href="structAcq200Device.html#a190b71a8087d48a3bf318d7377d41ce3" title="class generic.">class_dev</a>, &amp;dev_attr_dev);
<a name="l00423"></a>00423 
<a name="l00424"></a>00424 <span class="preprocessor">#ifndef ORIGINAL_CLASS_DEVICE_INTERFACE</span>
<a name="l00425"></a>00425 <span class="preprocessor"></span>        <span class="comment">/* create a symlink for the device */</span>
<a name="l00426"></a>00426         rc = sysfs_create_link(
<a name="l00427"></a>00427                 &amp;adev-&gt;<a class="code" href="structAcq200Device.html#a190b71a8087d48a3bf318d7377d41ce3" title="class generic.">class_dev</a>-&gt;kobj, &amp;adev-&gt;<a class="code" href="structAcq200Device.html#a8f801e5f490ffef5e7bd08f4a29c9d24" title="linux pci generic.">pci_dev</a>-&gt;dev.kobj, <span class="stringliteral">&quot;device&quot;</span>);
<a name="l00428"></a>00428 <span class="preprocessor">#endif</span>
<a name="l00429"></a>00429 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (rc) {
<a name="l00430"></a>00430                 <a class="code" href="acq200__debug_8h.html#abdc0ddb6c825c951cdc8e45b53459445">err</a>(<span class="stringliteral">&quot;failed to create symlink %s\n&quot;</span>, <span class="stringliteral">&quot;device&quot;</span>);
<a name="l00431"></a>00431         }       
<a name="l00432"></a>00432 
<a name="l00433"></a>00433 
<a name="l00434"></a>00434         <a class="code" href="acq200__debug_8h.html#aa91fbb7a1131706ff77fe51dd9903199">dbg</a>(1, <span class="stringliteral">&quot;9&quot;</span>);
<a name="l00435"></a>00435 }
<a name="l00436"></a>00436 
<a name="l00437"></a><a class="code" href="acq200__if_8c.html#ae729b82245aab78f52842262528f3790">00437</a> <span class="keywordtype">void</span> <a class="code" href="acq200_8h.html#ae729b82245aab78f52842262528f3790">acq200_remove_sysfs_class</a>(<span class="keyword">struct</span> <a class="code" href="structAcq200Device.html" title="device descriptor, one per device">Acq200Device</a> *adev)
<a name="l00438"></a>00438 {
<a name="l00439"></a>00439         device_remove_file(adev-&gt;<a class="code" href="structAcq200Device.html#a190b71a8087d48a3bf318d7377d41ce3" title="class generic.">class_dev</a>, &amp;dev_attr_imask);
<a name="l00440"></a>00440         device_remove_file(adev-&gt;<a class="code" href="structAcq200Device.html#a190b71a8087d48a3bf318d7377d41ce3" title="class generic.">class_dev</a>, &amp;dev_attr_dev);
<a name="l00441"></a>00441 }
<a name="l00442"></a>00442 
<a name="l00443"></a>00443 <span class="preprocessor">#endif</span>
<a name="l00444"></a>00444 <span class="preprocessor"></span>
<a name="l00445"></a>00445 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
